<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cigarette Count</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="bg"></div>

  <header class="topbar">
    <div class="brandText">
      <div class="title">Cigarette Count</div>
      <div class="sub">Taos 3158</div>
    </div>

    <nav class="actions">
      <a class="btn" href="index.html">Home</a>
      <a class="btn primary" href="history.html">Audit History</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <header class="cardHeader">
        <h1>Cigarette Count</h1>
        <p>Enter packs + cartons. Inventory total auto-calculates. Book total is manual. Over/Short is auto.</p>
      </header>

      <div class="cardBody">
        <form id="cigForm" class="stack">
          <input type="hidden" name="audit_type" value="Cigarette Count" />

          <!-- Header (NO time here; time will be at bottom by Submit) -->
          <div class="panel">
            <div class="grid2">
              <div class="field">
                <label>Employee (optional)</label>
                <input name="employee" placeholder="Name" />
              </div>

              <div class="field">
                <label>Date</label>
                <input type="date" name="audit_date" id="audit_date" />
              </div>

              <div class="field">
                <label>Notes (optional)</label>
                <input name="header_notes" placeholder="Anything important" />
              </div>

              <div class="field">
                <label>Prices</label>
                <div class="muted" style="margin-top:6px;">
                  Packs: <b>$8.00</b> • Cartons: <b>$80.00</b>
                </div>
              </div>
            </div>
          </div>

          <!-- PACK RACKS (12 rows) -->
          <div class="panel">
            <div class="row" style="align-items:flex-end;">
              <div>
                <div class="itemTitle">Pack Racks (12)</div>
                <div class="muted">Enter number of <b>packs</b> on each rack</div>
              </div>
              <div class="muted" id="packsSubtotalLabel"></div>
            </div>

            <div id="packRacks" class="stack" style="margin-top:12px;"></div>
          </div>

          <!-- DISCOUNTED (one rack) -->
          <div class="panel">
            <div class="row" style="align-items:flex-end;">
              <div>
                <div class="itemTitle">Discounted (1 rack)</div>
                <div class="muted">Enter number of <b>packs</b> in discounted</div>
              </div>
              <div class="muted" id="discountSubtotalLabel"></div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div class="field">
                <label>Discounted packs</label>
                <input inputmode="numeric" pattern="[0-9]*" name="discount_packs" id="discount_packs" placeholder="0" />
              </div>
              <div class="field">
                <label>Discounted value</label>
                <input readonly id="discount_value" />
              </div>
            </div>
          </div>

          <!-- CARTONS (5 sections) -->
          <div class="panel">
            <div class="row" style="align-items:flex-end;">
              <div>
                <div class="itemTitle">Cartons (5 sections)</div>
                <div class="muted">Enter number of <b>cartons</b> in each section</div>
              </div>
              <div class="muted" id="cartonsSubtotalLabel"></div>
            </div>

            <div id="cartonSections" class="stack" style="margin-top:12px;"></div>
          </div>

          <!-- TRUCK CARTONS (one) -->
          <div class="panel">
            <div class="row" style="align-items:flex-end;">
              <div>
                <div class="itemTitle">Truck Cartons</div>
                <div class="muted">If you received truck <b>before</b> counting, add cartons here</div>
              </div>
              <div class="muted" id="truckSubtotalLabel"></div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div class="field">
                <label>Truck cartons received</label>
                <input inputmode="numeric" pattern="[0-9]*" name="truck_cartons" id="truck_cartons" placeholder="0" />
              </div>
              <div class="field">
                <label>Truck value</label>
                <input readonly id="truck_value" />
              </div>
            </div>
          </div>

          <!-- BOOK TOTAL (manual) -->
          <div class="panel">
            <div class="itemTitle">Book Total (manual)</div>
            <div class="muted">Enter the book total from your paperwork</div>

            <div class="grid2" style="margin-top:12px;">
              <div class="field">
                <label>Book total ($)</label>
                <input inputmode="decimal" name="book_total" id="book_total" placeholder="0.00" />
              </div>
              <div class="field">
                <label>Packs equivalent (cartons count as 10 packs)</label>
                <input readonly id="packs_equiv" />
              </div>
            </div>
          </div>

          <!-- TOTALS -->
          <div class="panel">
            <div class="grid2">
              <div class="field">
                <label>Inventory total ($)</label>
                <input readonly id="inventory_total" />
              </div>
              <div class="field">
                <label>Over / Short</label>
                <input readonly id="over_short" />
                <div class="muted" id="over_short_label" style="margin-top:6px;"></div>
              </div>
            </div>
          </div>

          <!-- SUBMIT (time moved here) -->
          <div class="panel">
            <div class="row">
              <div style="min-width:220px;">
                <label style="display:block;margin-bottom:6px;">Time (optional)</label>
                <input type="time" name="audit_time" id="audit_time" />
              </div>

              <div class="row" style="gap:10px;">
                <a class="btn" href="index.html">Cancel</a>
                <button class="btn primary" type="submit">Submit</button>
              </div>
            </div>

            <p class="muted" style="margin-top:10px;">
              Saved locally on this device. Use Export/Import to share between devices.
            </p>
          </div>
        </form>
      </div>
    </section>

    <div class="foot">Store 3158 • Cigarette Count</div>
  </main>

  <script src="app.js"></script>
  <script>
    // ---- config ----
    const PRICE_PACK = 8.00;
    const PRICE_CARTON = 80.00;
    const PACK_RACKS = 7;
    const CARTON_SECTIONS = 4;
    const PACKS_PER_CARTON = 10;

    // ---- helpers ----
    const $ = (id) => document.getElementById(id);
    const nInt = (v) => {
      const x = parseInt(String(v ?? "").replace(/[^\d-]/g,""), 10);
      return Number.isFinite(x) && x > 0 ? x : 0;
    };
    const nMoney = (v) => {
      const x = parseFloat(String(v ?? "").replace(/[^0-9.\-]/g,""));
      return Number.isFinite(x) ? x : 0;
    };
    const money = (x) => (nMoney(x)).toLocaleString(undefined, { style:"currency", currency:"USD" });

    // ---- date default ----
    const d = new Date();
    $("audit_date").value = d.toISOString().slice(0,10);

    // ---- build pack racks ----
    const packWrap = $("packRacks");
    for(let i=1;i<=PACK_RACKS;i++){
      const div = document.createElement("div");
      div.className = "grid2";
      div.innerHTML = `
        <div class="field">
          <label>Rack ${i} (packs)</label>
          <input inputmode="numeric" pattern="[0-9]*" name="pack_rack_${i}" placeholder="0" />
        </div>
        </div>
      `;

    // ---- build carton sections ----
    const cartonWrap = $("cartonSections");
    for(let i=1;i<=CARTON_SECTIONS;i++){
      const div = document.createElement("div");
      div.className = "grid2";
      div.innerHTML = `
        <div class="field">
          <label>Section ${i} (cartons)</label>
          <input inputmode="numeric" pattern="[0-9]*" name="carton_section_${i}" placeholder="0" />
        </div>
      `;
      cartonWrap.appendChild(div);
    }

    function recalc(){
      // packs
      let packsTotal = 0;
      for(let i=1;i<=PACK_RACKS;i++){
        const v = nInt(document.querySelector(`[name="pack_rack_${i}"]`).value);
        packsTotal += v;
        $(`pack_rack_${i}_value`).value = money(v * PRICE_PACK);
      }
      const packsValue = packsTotal * PRICE_PACK;
      $("packsSubtotalLabel").textContent = `${packsTotal} packs • ${money(packsValue)}`;

      // discounted
      const discountPacks = nInt($("discount_packs").value);
      const discountValue = discountPacks * PRICE_PACK;
      $("discount_value").value = money(discountValue);
      $("discountSubtotalLabel").textContent = `${discountPacks} packs • ${money(discountValue)}`;

      // cartons
      let cartonsTotal = 0;
      for(let i=1;i<=CARTON_SECTIONS;i++){
        const v = nInt(document.querySelector(`[name="carton_section_${i}"]`).value);
        cartonsTotal += v;
        $(`carton_section_${i}_value`).value = money(v * PRICE_CARTON);
      }
      const cartonsValue = cartonsTotal * PRICE_CARTON;
      $("cartonsSubtotalLabel").textContent = `${cartonsTotal} cartons • ${money(cartonsValue)}`;

      // truck cartons
      const truckCartons = nInt($("truck_cartons").value);
      const truckValue = truckCartons * PRICE_CARTON;
      $("truck_value").value = money(truckValue);
      $("truckSubtotalLabel").textContent = `${truckCartons} cartons • ${money(truckValue)}`;

      // inventory total
      const inventoryTotal = packsValue + discountValue + cartonsValue + truckValue;
      $("inventory_total").value = money(inventoryTotal);

      // packs equivalent (cartons count as 10 packs)
      const packsEquiv = packsTotal + discountPacks + (cartonsTotal * PACKS_PER_CARTON) + (truckCartons * PACKS_PER_CARTON);
      $("packs_equiv").value = `${packsEquiv} packs`;

      // over/short
      const book = nMoney($("book_total").value);
      const diff = inventoryTotal - book; // positive = over
      $("over_short").value = money(Math.abs(diff));

      const label = $("over_short_label");
      if(book === 0 && inventoryTotal === 0){
        label.innerHTML = `<span class="muted">Enter counts + book total to calculate.</span>`;
      }else if(diff > 0){
        label.innerHTML = `<b>OVER</b> • ${money(diff)}`;
      }else if(diff < 0){
        label.innerHTML = `<b>SHORT</b> • ${money(Math.abs(diff))}`;
      }else{
        label.innerHTML = `<b>EVEN</b> • ${money(0)}`;
      }
    }

    // recalc on any input changes
    document.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", recalc);
      inp.addEventListener("change", recalc);
    });
    recalc();

    // ---- submit: save into audit storage with a nice summary + full details ----
    document.getElementById("cigForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const fd = new FormData(e.target);

      // totals again (source of truth)
      let packsTotal = 0;
      const packRacks = [];
      for(let i=1;i<=PACK_RACKS;i++){
        const v = nInt(fd.get(`pack_rack_${i}`));
        packsTotal += v;
        packRacks.push({ rack:i, packs:v });
      }
      const discountPacks = nInt(fd.get("discount_packs"));

      let cartonsTotal = 0;
      const cartonSections = [];
      for(let i=1;i<=CARTON_SECTIONS;i++){
        const v = nInt(fd.get(`carton_section_${i}`));
        cartonsTotal += v;
        cartonSections.push({ section:i, cartons:v });
      }
      const truckCartons = nInt(fd.get("truck_cartons"));

      const inventoryTotal =
        (packsTotal * PRICE_PACK) +
        (discountPacks * PRICE_PACK) +
        (cartonsTotal * PRICE_CARTON) +
        (truckCartons * PRICE_CARTON);

      const book = nMoney(fd.get("book_total"));
      const diff = inventoryTotal - book;

      const packsEquiv = packsTotal + discountPacks + (cartonsTotal * PACKS_PER_CARTON) + (truckCartons * PACKS_PER_CARTON);
      const overShortLabel = diff > 0 ? "OVER" : diff < 0 ? "SHORT" : "EVEN";

      // build audit object compatible with your existing history
      const audit = {
        id: (Math.random().toString(16).slice(2) + "-" + Date.now().toString(16)),
        
        audit_type: "Cigarette Count",
        audit_date: (fd.get("audit_date") || "").toString(),
        audit_time: (fd.get("audit_time") || "").toString(),
        header_notes: (fd.get("header_notes") || "").toString(),
        employee: (fd.get("employee") || "").toString(),
        device_name: (typeof getDeviceName === "function" ? getDeviceName() : ""),
        cig: {
          price_pack: PRICE_PACK,
          price_carton: PRICE_CARTON,
          packs_per_carton: PACKS_PER_CARTON,
          packs_total: packsTotal,
          discounted_packs: discountPacks,
          cartons_total: cartonsTotal,
          truck_cartons: truckCartons,
          packs_equiv: packsEquiv,
          inventory_total: inventoryTotal,
          book_total: book,
          over_short_label: overShortLabel,
          over_short_value: Math.abs(diff),
          diff: diff,
          pack_racks: packRacks,
          carton_sections: cartonSections
        },
        // also populate items so your existing “details view” works
        items: []
      };

      // Details items (packs)
      audit.items.push({ label:`Packs (total)`, kind:"notes", notes:`${packsTotal} packs` });
      for(const r of packRacks){
        audit.items.push({ label:`Rack ${r.rack} (packs)`, kind:"notes", notes:String(r.packs) });
      }

      // discounted
      audit.items.push({ label:`Discounted (packs)`, kind:"notes", notes:String(discountPacks) });

      // cartons
      audit.items.push({ label:`Cartons (total)`, kind:"notes", notes:`${cartonsTotal} cartons` });
      for(const s of cartonSections){
        audit.items.push({ label:`Carton Section ${s.section}`, kind:"notes", notes:String(s.cartons) });
      }

      // truck / totals
      audit.items.push({ label:`Truck Cartons`, kind:"notes", notes:String(truckCartons) });
      audit.items.push({ label:`Packs Equivalent (cartons=10 packs)`, kind:"notes", notes:`${packsEquiv} packs` });
      audit.items.push({ label:`Inventory Total`, kind:"notes", notes: money(inventoryTotal) });
      audit.items.push({ label:`Book Total`, kind:"notes", notes: money(book) });
      audit.items.push({ label:`Over/Short`, kind:"notes", notes: `${overShortLabel} • ${money(Math.abs(diff))}` });

      // Save using your existing storage
      const audits = (typeof loadAudits === "function" ? loadAudits() : []);
      audits.unshift(audit);
      if(typeof saveAudits === "function") saveAudits(audits);

      window.location.href = "history.html";
    });
  </script>
</body>
</html>
